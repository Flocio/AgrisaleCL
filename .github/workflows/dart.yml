name: Multi-Platform Build

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

env:
  FLUTTER_VERSION: "3.24.0"
  VERSION_TAG: "v1.1.2"

jobs:
  # iOS æ„å»º
  build-ios:
    name: iOS Build
    runs-on: macos-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          architecture: x64

      - name: Install Dependencies
        run: flutter pub get

      - name: Update CocoaPods
        run: pod repo update
        working-directory: ios

      - name: Build iOS Release
        run: flutter build ios --release --no-codesign

      - name: Create IPA
        run: |
          mkdir Payload
          mv Runner.app/ Payload
          zip -qq -r -9 agrisalecl-ios-${{ env.VERSION_TAG }}.ipa Payload
        working-directory: build/ios/iphoneos

      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: iOS-Build
          path: build/ios/iphoneos/agrisalecl-ios-${{ env.VERSION_TAG }}.ipa

  # Android æ„å»º
  build-android:
    name: Android Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Install Dependencies
        run: flutter pub get

      - name: Fix install_plugin namespace and AndroidManifest
        run: |
          python3 << 'PYEOF'
          import re
          import os
          
          home = os.environ.get('HOME', os.path.expanduser('~'))
          
          # ä¿®å¤ build.gradle - æ·»åŠ  namespace å’Œç»Ÿä¸€ JVM ç›®æ ‡ç‰ˆæœ¬
          build_gradle_path = os.path.join(home, '.pub-cache', 'hosted', 'pub.dev', 'install_plugin-2.1.0', 'android', 'build.gradle')
          if os.path.isfile(build_gradle_path):
              print(f'æ‰¾åˆ° build.gradle: {build_gradle_path}')
              with open(build_gradle_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              has_changes = False
              
              # æ·»åŠ  namespace
              if 'namespace' not in content:
                  pattern = r'(android\s*\{)'
                  replacement = r'\1\n    namespace "com.crazecoder.openfile"'
                  content = re.sub(pattern, replacement, content, count=1)
                  has_changes = True
                  print('âœ“ å·²æ·»åŠ  namespace åˆ° build.gradle')
              else:
                  print('âœ“ build.gradle å·²åŒ…å« namespace')
              
              # ä¿®å¤ compileSdkVersion - ç¡®ä¿è‡³å°‘ä¸º 30ï¼ˆJava 9+ è¦æ±‚ï¼‰ï¼Œæœ€å¥½è®¾ç½®ä¸º 35
              if 'compileSdkVersion' in content:
                  # æ£€æŸ¥å½“å‰çš„ compileSdkVersion å€¼
                  match = re.search(r'compileSdkVersion\s+(\d+)', content)
                  if match:
                      current_sdk = int(match.group(1))
                      if current_sdk < 35:
                          content = re.sub(r'compileSdkVersion\s+\d+', 'compileSdkVersion 35', content)
                          has_changes = True
                          print(f'âœ“ å·²æ›´æ–° compileSdkVersion ä» {current_sdk} åˆ° 35')
                      else:
                          print(f'âœ“ compileSdkVersion å·²è®¾ç½®ä¸º {current_sdk}')
                  else:
                      # å¦‚æœæ ¼å¼ä¸åŒï¼Œå°è¯•æ›¿æ¢
                      content = re.sub(r'compileSdkVersion\s*[^\n]+', 'compileSdkVersion 35', content)
                      has_changes = True
                      print('âœ“ å·²è®¾ç½® compileSdkVersion ä¸º 35')
              else:
                  # å¦‚æœæ²¡æœ‰ compileSdkVersionï¼Œæ·»åŠ å®ƒï¼ˆåœ¨ namespace ä¹‹åï¼‰
                  if 'namespace' in content:
                      pattern = r'(namespace\s+"[^"]+"\s*\n)'
                      replacement = r'\1    compileSdkVersion 35\n'
                      content = re.sub(pattern, replacement, content, count=1)
                      has_changes = True
                      print('âœ“ å·²æ·»åŠ  compileSdkVersion 35')
                  elif 'android {' in content:
                      pattern = r'(android\s*\{)'
                      replacement = r'\1\n    compileSdkVersion 35'
                      content = re.sub(pattern, replacement, content, count=1)
                      has_changes = True
                      print('âœ“ å·²æ·»åŠ  compileSdkVersion 35')
              
              # ç»Ÿä¸€ JVM ç›®æ ‡ç‰ˆæœ¬ä¸º 11ï¼ˆä¸é¡¹ç›®é…ç½®ä¸€è‡´ï¼‰
              # ä¿®å¤ compileOptions - å°† Java 1.8 æ”¹ä¸º 11
              if 'VERSION_1_8' in content:
                  content = re.sub(r'VERSION_1_8', 'VERSION_11', content)
                  has_changes = True
                  print('âœ“ å·²æ›´æ–° Java ç‰ˆæœ¬ä» 1.8 åˆ° 11')
              
              # ä¿®å¤ kotlinOptions - å°† jvmTarget 1.8 æ”¹ä¸º 11
              if 'jvmTarget' in content:
                  # åŒ¹é… jvmTarget = "1.8" æˆ– jvmTarget = '1.8'
                  content = re.sub(r'jvmTarget\s*=\s*["\']1\.8["\']', 'jvmTarget = "11"', content)
                  if 'jvmTarget = "11"' in content or "jvmTarget = '11'" in content:
                      print('âœ“ kotlinOptions jvmTarget å·²è®¾ç½®ä¸º 11')
                  else:
                      has_changes = True
                      print('âœ“ å·²æ›´æ–° kotlinOptions jvmTarget åˆ° 11')
              
              # å¦‚æœæ²¡æœ‰ compileOptionsï¼Œæ·»åŠ å®ƒ
              if 'compileOptions' not in content and 'android {' in content:
                  # åœ¨ android { åæ·»åŠ  compileOptions
                  pattern = r'(android\s*\{)'
                  replacement = r'\1\n    compileOptions {\n        sourceCompatibility JavaVersion.VERSION_11\n        targetCompatibility JavaVersion.VERSION_11\n    }'
                  content = re.sub(pattern, replacement, content, count=1)
                  has_changes = True
                  print('âœ“ å·²æ·»åŠ  compileOptions é…ç½®')
              
              # å¦‚æœæ²¡æœ‰ kotlinOptionsï¼Œæ·»åŠ å®ƒ
              if 'kotlinOptions' not in content and 'compileOptions' in content:
                  # åœ¨ compileOptions åæ·»åŠ  kotlinOptions
                  pattern = r'(compileOptions\s*\{[^\}]*?\})'
                  replacement = r'\1\n    kotlinOptions {\n        jvmTarget = "11"\n    }'
                  content = re.sub(pattern, replacement, content, count=1)
                  has_changes = True
                  print('âœ“ å·²æ·»åŠ  kotlinOptions é…ç½®')
              
              if has_changes:
                  with open(build_gradle_path, 'w', encoding='utf-8') as f:
                      f.write(content)
                  print('âœ“ build.gradle ä¿®å¤å®Œæˆ')
          else:
              print(f'è­¦å‘Š: æœªæ‰¾åˆ° build.gradle: {build_gradle_path}')
          
          # ä¿®å¤ AndroidManifest.xml - ç§»é™¤ package å±æ€§
          manifest_path = os.path.join(home, '.pub-cache', 'hosted', 'pub.dev', 'install_plugin-2.1.0', 'android', 'src', 'main', 'AndroidManifest.xml')
          if os.path.isfile(manifest_path):
              print(f'æ‰¾åˆ° AndroidManifest.xml: {manifest_path}')
              with open(manifest_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # ç§»é™¤ package å±æ€§
              if 'package=' in content:
                  # åŒ¹é… package="..." æˆ– package='...'
                  pattern = r'\s*package\s*=\s*["\'][^"\']*["\']'
                  new_content = re.sub(pattern, '', content)
                  
                  with open(manifest_path, 'w', encoding='utf-8') as f:
                      f.write(new_content)
                  print('âœ“ å·²ç§»é™¤ AndroidManifest.xml ä¸­çš„ package å±æ€§')
              else:
                  print('âœ“ AndroidManifest.xml ä¸­å·²æ—  package å±æ€§')
          else:
              print(f'è­¦å‘Š: æœªæ‰¾åˆ° AndroidManifest.xml: {manifest_path}')
          PYEOF

      - name: Restore Android keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/agrisale-release.jks
          chmod 600 android/app/agrisale-release.jks

      - name: Create key.properties
        run: |
          echo "storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=agrisale-release.jks" >> android/key.properties

      - name: Build Android APK
        run: flutter build apk --release

      - name: Build Android App Bundle
        run: flutter build appbundle --release

      - name: Rename Build Files
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/agrisalecl-android-${{ env.VERSION_TAG }}.apk
          mv build/app/outputs/bundle/release/app-release.aab build/app/outputs/bundle/release/agrisalecl-android-${{ env.VERSION_TAG }}.aab

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: Android-APK
          path: build/app/outputs/flutter-apk/agrisalecl-android-${{ env.VERSION_TAG }}.apk

      - name: Upload Android Bundle
        uses: actions/upload-artifact@v4
        with:
          name: Android-Bundle
          path: build/app/outputs/bundle/release/agrisalecl-android-${{ env.VERSION_TAG }}.aab

  # macOS æ„å»º
  build-macos:
    name: macOS Build
    runs-on: macos-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          architecture: x64

      - name: Enable macOS Desktop
        run: flutter config --enable-macos-desktop

      - name: Install Dependencies
        run: flutter pub get

      - name: Update CocoaPods
        run: pod repo update
        working-directory: macos

      - name: Build macOS Release
        run: flutter build macos --release

      - name: Create macOS Archive
        run: |
          cd build/macos/Build/Products/Release
          zip -qq -r -9 ../../../../../agrisalecl-macos-${{ env.VERSION_TAG }}.zip agrisalecl.app

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macOS-Build
          path: agrisalecl-macos-${{ env.VERSION_TAG }}.zip

  # Windows æ„å»º
  build-windows:
    name: Windows Build
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Enable Windows Desktop
        run: flutter config --enable-windows-desktop

      - name: Install Dependencies
        run: flutter pub get

      - name: Build Windows Release
        run: flutter build windows --release

      - name: Create Windows Archive
        run: |
          Compress-Archive -Path "build\windows\x64\runner\Release\*" -DestinationPath "agrisalecl-windows-${{ env.VERSION_TAG }}.zip"

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Build
          path: agrisalecl-windows-${{ env.VERSION_TAG }}.zip

  # åˆ›å»º GitHub Release
  create-release:
    name: Create Release
    needs: [build-ios, build-android, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -la artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION_TAG }}
          name: "AgrisaleCL ${{ env.VERSION_TAG }}"
          body: |
            ## AgrisaleCL ${{ env.VERSION_TAG }} - åˆ†å¸ƒå¼æ•°æ®åŒæ­¥ç¬¬ä¸€ç‰ˆ
            
            ### ğŸ‰ é‡è¦é‡Œç¨‹ç¢‘
            è¿™æ˜¯ AgrisaleCL çš„ç¬¬ä¸€ä¸ªæ­£å¼ç‰ˆæœ¬ï¼Œå®ç°äº†**åˆ†å¸ƒå¼æ•°æ®åŒæ­¥åŠŸèƒ½**ï¼Œæ ‡å¿—ç€ä»å•æœºåº”ç”¨å‘äº‘ç«¯åä½œåº”ç”¨çš„é‡å¤§å‡çº§ï¼
            
            ### æ”¯æŒå¹³å°
            - iOS: iPhone å’Œ iPad
            - Android: æ‰‹æœºå’Œå¹³æ¿
            - macOS: Mac æ¡Œé¢åº”ç”¨
            - Windows: Windows æ¡Œé¢åº”ç”¨
            
            ### æ ¸å¿ƒç‰¹æ€§
            
            #### â˜ï¸ äº‘ç«¯æœåŠ¡å™¨å­˜å‚¨
            - æ‰€æœ‰ä¸šåŠ¡æ•°æ®å­˜å‚¨åœ¨äº‘ç«¯æœåŠ¡å™¨
            - æ•°æ®å®‰å…¨å¯é ï¼Œæ°¸ä¸ä¸¢å¤±
            - æ”¯æŒå¤šè®¾å¤‡åŒæ­¥è®¿é—®
            
            #### ğŸ‘¥ ç”¨æˆ·åä½œæ”¯æŒ
            - å¤šç”¨æˆ·ç‹¬ç«‹æ•°æ®ç©ºé—´
            - æ¯ä¸ªç”¨æˆ·çš„æ•°æ®å®Œå…¨éš”ç¦»
            - æ”¯æŒå¤šè®¾å¤‡åŒæ—¶ç™»å½•åŒä¸€è´¦å·
            
            #### ğŸ“Š ä¸»è¦åŠŸèƒ½
            - äº§å“åº“å­˜ç®¡ç†
            - é‡‡è´­é”€å”®ç®¡ç†
            - å®¢æˆ·ä¾›åº”å•†ç®¡ç†
            - å‘˜å·¥ç®¡ç†
            - è¿›è´¦æ±‡æ¬¾ç®¡ç†
            - è´¢åŠ¡æŠ¥è¡¨ç»Ÿè®¡
            - AI æ•°æ®åˆ†æåŠ©æ‰‹ï¼ˆæµå¼è¾“å‡ºï¼‰
            - æ•°æ®å¤‡ä»½æ¢å¤
            - è‡ªåŠ¨å¤‡ä»½åŠŸèƒ½
            - åœ¨çº¿è®¾å¤‡æ˜¾ç¤º
            
            ### v1.0.0 æ ¸å¿ƒåŠŸèƒ½
            - **åˆ†å¸ƒå¼æ•°æ®åŒæ­¥**ï¼šæ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨äº‘ç«¯æœåŠ¡å™¨ï¼Œæ”¯æŒå¤šè®¾å¤‡å®æ—¶åŒæ­¥
            - **äº‘ç«¯åä½œæ¶æ„**ï¼šé‡‡ç”¨ FastAPI + SQLite æœåŠ¡å™¨æ¶æ„ï¼Œæ•°æ®é›†ä¸­ç®¡ç†
            - **å¤šè®¾å¤‡æ”¯æŒ**ï¼šåŒä¸€è´¦å·å¯åœ¨å¤šä¸ªè®¾å¤‡ç™»å½•ï¼Œå®æ—¶åŒæ­¥æ•°æ®
            - **åœ¨çº¿è®¾å¤‡æ˜¾ç¤º**ï¼šå®æ—¶æ˜¾ç¤ºå½“å‰è´¦å·çš„åœ¨çº¿è®¾å¤‡æ•°é‡
            - **æµå¼ AI è¾“å‡º**ï¼šæ•°æ®åˆ†æåŠ©æ‰‹æ”¯æŒé€å­—æµå¼è¾“å‡ºï¼Œä½“éªŒæ›´æµç•…
            - **æ•°æ®å¯¼å…¥å¯¼å‡º**ï¼šæ”¯æŒå®Œæ•´æ•°æ®å¤‡ä»½å’Œæ¢å¤
            - **è‡ªåŠ¨å¤‡ä»½**ï¼šå¯é…ç½®è‡ªåŠ¨å¤‡ä»½é—´éš”å’Œæœ€å¤§å¤‡ä»½æ•°é‡
            - **è´¦æˆ·è®¾ç½®**ï¼šç‹¬ç«‹çš„è´¦æˆ·è®¾ç½®é¡µé¢ï¼Œç®¡ç†å¯†ç å’Œç³»ç»Ÿåå¥½
            - **æ¨¡å‹è®¾ç½®**ï¼šç‹¬ç«‹çš„ AI æ¨¡å‹è®¾ç½®é¡µé¢ï¼Œæ”¯æŒ DeepSeek æ¨¡å‹é…ç½®
            - **ç‰ˆæœ¬ä¿¡æ¯**ï¼šç»Ÿä¸€çš„ç‰ˆæœ¬ä¿¡æ¯é¡µé¢ï¼Œæ”¯æŒæ‰‹åŠ¨æ£€æŸ¥æ›´æ–°
            
            ### v1.1.0 æ›´æ–°å†…å®¹
            - **ä¿®å¤é€€å‡ºç™»å½•é—®é¢˜**ï¼šä¿®å¤é€€å‡ºç™»å½•æ—¶è¯¯åˆ æ‰€æœ‰è®¾å¤‡è®°å½•çš„é—®é¢˜ï¼Œç°åœ¨åªåˆ é™¤å½“å‰è®¾å¤‡çš„è®°å½•
            - **è®¾å¤‡å¹³å°æ˜¾ç¤º**ï¼šåœ¨çº¿è®¾å¤‡åˆ—è¡¨ç°åœ¨æ˜¾ç¤ºæ¯ä¸ªè®¾å¤‡çš„å¹³å°ä¿¡æ¯ï¼ˆAndroidã€iOSã€macOSç­‰ï¼‰
            - **æ¨¡å‹è®¾ç½®ä¼˜åŒ–**ï¼šä¿®å¤æ¨¡å‹è®¾ç½®é¡µé¢åŠ è½½æ—¶çš„é—ªçƒé—®é¢˜ï¼Œæ·»åŠ åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨
            - **ç”¨æˆ·ä½“éªŒæ”¹è¿›**ï¼šä¼˜åŒ–è®¾ç½®åŠ è½½æµç¨‹ï¼Œæå‡ç•Œé¢å“åº”é€Ÿåº¦
            
            ### ä¸‹è½½è¯´æ˜
            - iOSç”¨æˆ·: ä¸‹è½½ `agrisalecl-ios-${{ env.VERSION_TAG }}.ipa` æ–‡ä»¶
            - Androidç”¨æˆ·: ä¸‹è½½ `agrisalecl-android-${{ env.VERSION_TAG }}.apk` æ–‡ä»¶
            - macOSç”¨æˆ·: ä¸‹è½½ `agrisalecl-macos-${{ env.VERSION_TAG }}.zip` æ–‡ä»¶
            - Windowsç”¨æˆ·: ä¸‹è½½ `agrisalecl-windows-${{ env.VERSION_TAG }}.zip` æ–‡ä»¶
            
            ### å®‰è£…è¯´æ˜
            - iOS: éœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·å¦‚ AltStore æˆ–ä¼ä¸šè¯ä¹¦å®‰è£…
            - Android: å¼€å¯"æœªçŸ¥æ¥æºåº”ç”¨"åç›´æ¥å®‰è£…
            - macOS: è§£å‹åæ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
            - Windows: è§£å‹åè¿è¡Œ agrisalecl.exe
            
            ---
            
            å®Œæ•´è·¨å¹³å°æ”¯æŒ | åŸç”Ÿç”¨æˆ·ä½“éªŒ | å¼€æºå…è´¹
          files: |
            artifacts/iOS-Build/agrisalecl-ios-${{ env.VERSION_TAG }}.ipa
            artifacts/Android-APK/agrisalecl-android-${{ env.VERSION_TAG }}.apk
            artifacts/Android-Bundle/agrisalecl-android-${{ env.VERSION_TAG }}.aab
            artifacts/macOS-Build/agrisalecl-macos-${{ env.VERSION_TAG }}.zip
            artifacts/Windows-Build/agrisalecl-windows-${{ env.VERSION_TAG }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

